# FFXIV Performance Generator

This is a library that compiles scores written in Music Macro Language ("MML
Codes" written for Mabinogi or Archeage) into the network packets for the
"Perform" action in Final Fantasy 14.

## Usage

Currently, this is only used as a Golang library with no additional
dependencies. Simply add `import "github.com/ff14wed/performgen"` and
pass the MML string to the `perform.Generate()` call to receive byte data
for an FFXIV performance, split into segments.

These segments can be sent from a certain private server implementation or
packet injected into the FFXIV client itself.

The network protocol format for a single segment of a performance is a
32 byte block structured as defined [here](encoding/perform.go). When the
FFXIV client receives a single segment from the server, it queues it for the
performing character and reads the data from this queue as the notes play.
If the client receives multiple segments at once, they will be read in order
instead of overlapping.

This is useful because instead of sending one note at a time with delay
in between, you can send an entire section of music and it will be played
with the correct timing. However, this queue has a limited size buffer,
so sending an entire song at once would result in only the last section
of the song playing.

## Internal Documentation

https://godoc.org/github.com/ff14wed/performgen

## MML Reference

The MML understood by this compiler is a slight variation of what is understood
by Mabinogi or generated by the 3MLE tool.

The major difference is that it can only understand one track at a time, so
while you can import a song in the `MML@Melody,Harmony1,Harmony2,Song;` format
into 3MLE, this compiler can only understand each of `Melody`, `Harmony1`,
`Harmony2`, or `Song` without commas or semicolons or the `MML@` header.

Most of these commands behave the same way as in other MML, so some of this
reference is borrowed from existing documentation. The parser is case
insensitive, so the symbols used could be uppercase or lowercase.

### Note Command
**Symbols: A, B, C, D, E, F, G**

A note command will produce a sound with the letters `A` to `G` corresponding
to the pitches.

A sharp note can be produced by adding a `+` or a `#` directly after the pitch
letter, and flat notes by adding a `-`.

The length of a note is specified by appending a positive integer representing
the denominator of 1/x, which translates mean the length is this fraction a
whole note. For example, `c8` would produce a C eighth note, and `f+2` would
produce a F♯ half note. If the length of the note is not specified, the default
length specified by the [length command](#length-command) will be assumed.

If the length is explicitly set to 0, this note will be used to form a chord
with the next note. For example, `c0e0g0` forms a C Major triad. Implementation
wise, this is achieved by making an arpeggiated chord with 20 milliseconds
of delay in between each note.

Adding a dot or a period `.` after the number specifying the length increases
the length of the note by 50%. For example `f+8.` plays the an F# note for 3/16
of a whole note.

It's important to note that FFXIV doesn't currently support any sort of sustain
for notes, so adding a length for a note is pretty much equivalent to a rest
after the note.

### Rest Command
**Symbol: R**

A rest is an interval of silence in the music. The length of the rest is
specified in the same manner as the length of the note. It also supports
the dot for increasing its length by 50%. For example, `r8.` is an interval
of silence for 3/16 of a whole note.

### Octave Command
**Symbol: O**

The octave can by set for all notes after this command by specifying `o`
followed by a number. Currently, FFXIV only supports octaves 3, 4, 5, or 6,
so setting any other octave generates an error in this tool. These octaves
correspond to the -1, 0, 1, and 2 numbers in-game. For example, `o5 g a b g`
plays `G (+1), A (+1), B (+1), G (+1)` in game.

Keep in mind you can only play the C note on octave 6 (`C (+2)`). Any other
note on this octave will generate an error.

Before using this tool, it is advisable to import the MML into an editor like
3MLE first to make sure it doesn't require going out of the 3-6 octave range,
and if it does, change some notes around accordingly or shift the song up or
down an octave.

### Octave Up/Down Command
**Symbol: >, <**

These commands don't take any arguments. The `>` steps the octave up by one,
and `<` steps the octave down by one. Shifting the octave outside of the
3-6 range will generate an error.

### Length Command
**Symbol: L**

The default length of all notes/rests without an explicit length after this
command can be set by specifying `l` followed by a number. This number is
specified in the same manner as the length of the note. This number can also
be modified with the dot to make the default length 50% longer. For example,
`l8.` makes the default length 3/16 of a whole note.

If this command is never called, notes without an explicit length will be
quarter notes.

### Tempo Command
**Symbol: T**

The tempo of the song can be changed by specifying `t` followed by the tempo
in beats per minute. For example `t88` sets the tempo to 88 bpm. The default
tempo is 120 beats per minute.

### Volume Command
**Symbol: V**

This command does nothing since FFXIV doesn't support volume. It is only
implemented to parse without error scores from other games. It must still be
followed by a number. For example, `v120` would be parsed and ignored.

### Extend Command
**Symbol: &**

This command is originally used to extend the duration of the previous note.
For example `e-1&e-1&e-1&e-1` would extend the note E♭ to one full measure.
However, since FFXIV doesn't currently support sustained notes, this would
only translate into a single E♭ and a full measure of silence.

In order to support compatibility with MML used in other games, this command
has the following behavior:

- It is used by specifying a `&` followed by a full note command or a full rest
command. It doesn't matter whether there is anything before the `&` or not.
- It always adds a rest with the duration of the following note or rest
command. For example, `&a+8` is equivalent to a `r8`, and `&r4` is equivalent
to a `r4`.
